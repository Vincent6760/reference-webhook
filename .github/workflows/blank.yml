name: Reference Discord Question

on:
  schedule:
    - cron: "0 10 */3 * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  send-message:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Send next question
        run: |
          # ======================================
          hi
          # ======================================

          readarray -t QUESTIONS << 'EOF'
          EOF

          # ======================================
          # DO NOT EDIT BELOW THIS LINE
          # ======================================

          if [ "${#QUESTIONS[@]}" -eq 0 ]; then
            echo "No questions found. Exiting."
            exit 0
          fi

          INDEX_FILE=".question_index"

          if [ ! -f "$INDEX_FILE" ]; then
            echo 0 > "$INDEX_FILE"
          fi

          INDEX=$(cat "$INDEX_FILE")

          if [ "$INDEX" -ge "${#QUESTIONS[@]}" ]; then
            INDEX=0
          fi

          MESSAGE="${QUESTIONS[$INDEX]}"
          NEXT_INDEX=$((INDEX + 1))

          echo $NEXT_INDEX > "$INDEX_FILE"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add "$INDEX_FILE"

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Rotate reference webhook question"
            git push
          fi

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"$MESSAGE\"}" \
            ${{ secrets.TORU }}
